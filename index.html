<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One-Touch Camera App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #333;
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            max-width: 80%;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #stopButton {
            width: 150px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Modal for messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Message</h3>
            <p id="modalMessage" class="text-lg mb-6"></p>
            <button id="closeModal" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full transition-all duration-300">OK</button>
        </div>
    </div>

    <div class="w-full max-w-sm bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col items-center justify-center">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-100">One-Touch Camera App</h1>

        <!-- The "App Icon" Button -->
        <button id="appIcon" class="flex flex-col items-center justify-center p-4 rounded-3xl w-24 h-24 transform transition-transform duration-200 hover:scale-105 active:scale-95">
            <svg class="w-16 h-16 text-gray-300 mb-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
            </svg>
            <span class="text-xs text-gray-400">Camera</span>
        </button>
        <p class="text-center text-sm text-gray-400 mt-2">Click to simulate launching the app.</p>

        <!-- Video and Recording Status UI -->
        <div id="cameraView" class="hidden w-full h-80 bg-black rounded-lg mt-6 overflow-hidden relative">
            <video id="videoElement" class="w-full h-full object-cover"></video>
            <div id="recordingStatus" class="absolute top-2 left-2 flex items-center bg-red-600 text-white text-xs font-semibold px-2 py-1 rounded-full">
                <div class="w-2 h-2 rounded-full bg-white animate-pulse mr-1"></div>
                Recording
            </div>
            <button id="stopButton" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white font-semibold py-2 px-4 rounded-full border-4 border-white transition-colors duration-200 hover:bg-red-400 active:scale-95">Stop Recording</button>
        </div>

        <!-- Gemini API Analysis UI -->
        <div id="analysisContainer" class="hidden w-full mt-6">
            <button id="saveVideoButton" class="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300 mb-4">
                Save Video
            </button>

            <h2 class="text-xl font-bold mb-4 text-center">Video Notes</h2>
            <p class="text-sm text-center text-gray-400 mb-2">Describe what you just recorded.</p>
            <textarea id="videoNotes" class="w-full h-24 p-2 rounded-lg bg-gray-700 text-white placeholder-gray-500 resize-none focus:outline-none focus:ring-2 focus:ring-blue-600 mb-4" placeholder="e.g., A dog fetching a stick in the park on a sunny day."></textarea>
            
            <button id="analyzeButton" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300">
                <span id="analyzeText">✨ Analyze Video Notes ✨</span>
            </button>
            
            <div id="analysisResult" class="hidden mt-6 p-4 rounded-lg bg-gray-700 border border-gray-600">
                <h3 class="font-bold text-lg mb-2">Analysis Result:</h3>
                <div id="resultContent" class="text-sm text-gray-200"></div>
            </div>

            <button id="startNewRecording" class="w-full mt-4 flex items-center justify-center bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300">
                Start New Recording
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appIcon = document.getElementById('appIcon');
            const cameraView = document.getElementById('cameraView');
            const videoElement = document.getElementById('videoElement');
            const stopButton = document.getElementById('stopButton');
            const saveVideoButton = document.getElementById('saveVideoButton');
            const messageModal = document.getElementById('messageModal');
            const modalMessage = document.getElementById('modalMessage');
            const closeModal = document.getElementById('closeModal');
            const analysisContainer = document.getElementById('analysisContainer');
            const videoNotes = document.getElementById('videoNotes');
            const analyzeButton = document.getElementById('analyzeButton');
            const analyzeText = document.getElementById('analyzeText');
            const analysisResult = document.getElementById('analysisResult');
            const resultContent = document.getElementById('resultContent');
            const startNewRecordingButton = document.getElementById('startNewRecording');
            
            let clickCount = 0;
            let timer = null;
            let mediaRecorder;
            let videoChunks = [];
            const API_KEY = "";
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            function showModal(message) {
                modalMessage.textContent = message;
                messageModal.style.display = 'flex';
            }

            closeModal.addEventListener('click', () => {
                messageModal.style.display = 'none';
            });

            async function startRecording() {
                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment'
                        },
                        audio: true
                    };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    videoElement.play();
                    
                    videoChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => {
                        videoChunks.push(event.data);
                    };
                    mediaRecorder.start();

                    cameraView.classList.remove('hidden');
                    analysisContainer.classList.add('hidden');
                    saveVideoButton.classList.add('hidden');
                    showModal("Camera launched and recording started! This is how an instant app would feel.");

                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    if (err.name === "NotAllowedError" || err.name === "PermissionDismissedError") {
                        showModal("Permission to access the camera was denied. Please try again and accept the permission pop-up to continue.");
                    } else if (err.name === "OverconstrainedError") {
                         showModal("The back camera is not available or in use. Trying to open the front camera instead.");
                         try {
                            const constraints = {
                                video: {
                                    facingMode: 'user'
                                },
                                audio: true
                            };
                            const stream = await navigator.mediaDevices.getUserMedia(constraints);
                            videoElement.srcObject = stream;
                            videoElement.play();
                            
                            videoChunks = [];
                            mediaRecorder = new MediaRecorder(stream);
                            mediaRecorder.ondataavailable = event => {
                                videoChunks.push(event.data);
                            };
                            mediaRecorder.start();
                            
                            cameraView.classList.remove('hidden');
                            analysisContainer.classList.add('hidden');
                            saveVideoButton.classList.add('hidden');
                            showModal("Front camera opened. Please accept the permission pop-up to continue.");

                        } catch (fallbackErr) {
                            console.error("Fallback error: ", fallbackErr);
                            showModal("Error: Could not access any camera. Please check your device settings.");
                        }
                    } else {
                        showModal("Error: Could not access the camera. Please make sure you have given permission.");
                    }
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }

                const stream = videoElement.srcObject;
                if (stream) {
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    videoElement.srcObject = null;
                }
                
                cameraView.classList.add('hidden');
                analysisContainer.classList.remove('hidden');
                saveVideoButton.classList.remove('hidden');
                analysisResult.classList.add('hidden');
                videoNotes.value = '';
                showModal("Recording stopped. Now, you can save the video and describe what you recorded to get an analysis!");
            }

            function saveVideo() {
                if (videoChunks.length === 0) {
                    showModal("No video was recorded to save.");
                    return;
                }
                const videoBlob = new Blob(videoChunks, { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = videoUrl;
                a.download = `one-touch-video-${Date.now()}.mp4`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(videoUrl);
                showModal("Video saved successfully!");
            }

            async function analyzeNotes() {
                const userNotes = videoNotes.value.trim();
                if (!userNotes) {
                    showModal("Please enter some notes to analyze.");
                    return;
                }

                analyzeText.innerHTML = '<div class="spinner"></div>';
                analyzeButton.disabled = true;

                const systemPrompt = "You are a helpful assistant that analyzes video notes. Provide a concise summary and a suggested title for the video based on the user's notes. Format your response with a clear 'Title' and 'Summary' section.";
                const userQuery = `Analyze the following video notes: \"${userNotes}\"`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        resultContent.innerHTML = text.replace(/\n/g, '<br>');
                        analysisResult.classList.remove('hidden');
                    } else {
                        throw new Error("Invalid API response format.");
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    resultContent.textContent = "Error: Could not get a summary. Please try again.";
                    analysisResult.classList.remove('hidden');
                } finally {
                    analyzeText.textContent = '✨ Analyze Video Notes ✨';
                    analyzeButton.disabled = false;
                }
            }

            appIcon.addEventListener('click', () => {
                clickCount++;

                if (clickCount === 1) {
                    timer = setTimeout(() => {
                        // Handle single click
                        startRecording();
                        clickCount = 0;
                    }, 300); // 300ms timeout to differentiate single from double click
                } else if (clickCount === 2) {
                    // Handle double click
                    clearTimeout(timer);
                    startRecording();
                    clickCount = 0;
                }
            });

            stopButton.addEventListener('click', stopRecording);
            saveVideoButton.addEventListener('click', saveVideo);
            analyzeButton.addEventListener('click', analyzeNotes);
            startNewRecordingButton.addEventListener('click', () => {
                location.reload();
            });
        });
    </script>
</body>
</html>